<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LayersControl - Refactored Demo</title>
    
    <!-- MapLibre GL CSS -->
    <link href="https://unpkg.com/maplibre-gl@4.1.1/dist/maplibre-gl.css" rel="stylesheet">
    <link href="./src/css/main.css" rel="stylesheet">
    
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }

        /* LayersControl Styles */
        .maplibregl-ctrl.layers-control {
            background: white;
            border-radius: 4px;
            box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.1);
        }

        .layers-control-toggle {
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            font-size: 16px;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 29px;
            height: 29px;
        }

        .layers-control-toggle:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .layers-control-panel {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
            min-width: 200px;
            max-width: 300px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            margin-top: 4px;
        }

        .layers-section {
            padding: 8px 0;
        }

        .layers-section:not(:last-child) {
            border-bottom: 1px solid #eee;
        }

        .layers-section-title {
            font-weight: 600;
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 4px 12px 8px;
        }

        .layers-list {
            /* Container for layer items */
        }

        .layers-item {
            padding: 6px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            font-size: 14px;
        }

        .layers-item:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .layers-item.group-item {
            font-weight: 500;
            background-color: rgba(0, 0, 0, 0.02);
        }

        .overlay-label {
            display: flex;
            align-items: center;
            flex: 1;
            cursor: pointer;
        }

        .layers-item input[type="radio"],
        .layers-item input[type="checkbox"] {
            margin-right: 8px;
            cursor: pointer;
        }

        .overlay-status {
            margin-left: 8px;
            font-size: 12px;
            display: none;
        }

        .overlay-status.loading {
            color: #007cba;
            animation: spin 1s linear infinite;
        }

        .overlay-status.error {
            color: #d63031;
            cursor: pointer;
        }

        .overlay-status.error:hover {
            color: #a71e1e;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .opacity-control {
            margin-top: 4px;
            padding: 0 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .opacity-slider {
            flex: 1;
            height: 4px;
            background: #ddd;
            border-radius: 2px;
            outline: none;
            cursor: pointer;
        }

        .opacity-slider::-webkit-slider-thumb {
            appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #007cba;
            cursor: pointer;
        }

        .opacity-slider::-moz-range-thumb {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #007cba;
            cursor: pointer;
            border: none;
        }

        .opacity-label {
            font-size: 11px;
            color: #666;
            min-width: 30px;
            text-align: right;
        }

        /* Demo Info Panel */
        .demo-info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 6px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
            max-width: 300px;
            font-size: 14px;
            z-index: 1000;
        }

        .demo-info h3 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 16px;
        }

        .demo-info p {
            margin: 0 0 8px 0;
            color: #666;
            line-height: 1.4;
        }

        .demo-info .close-btn {
            position: absolute;
            top: 5px;
            right: 8px;
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #999;
        }

        .demo-info .close-btn:hover {
            color: #333;
        }

        /* Console Output */
        .console-output {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: #00ff00;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-width: 400px;
            max-height: 150px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .console-output.show {
            display: block;
        }

        .console-line {
            margin-bottom: 2px;
        }

        .console-toggle {
            position: absolute;
            bottom: 10px;
            right: 60px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            z-index: 1000;
        }

        .console-toggle:hover {
            background: rgba(0, 0, 0, 0.9);
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <!-- Demo Info Panel -->
    <div class="demo-info" id="demoInfo">
        <button class="close-btn" onclick="document.getElementById('demoInfo').style.display='none'">&times;</button>
        <h3>LayersControl - Refactored Demo</h3>
        <p><strong>Features:</strong></p>
        <p>• Multiple base maps (OSM Liberty, Satellite)</p>
        <p>• Grouped overlays (Points of Interest)</p>
        <p>• Dynamic loading (Weather Radar)</p>
        <p>• Opacity controls and state persistence</p>
        <p>• Automatic layer positioning</p>
        <p><strong>Try:</strong> Toggle layers, adjust opacity, refresh page to see persistence!</p>
    </div>

    <!-- Console Toggle -->
    <button class="console-toggle" onclick="toggleConsole()">Toggle Console</button>
    
    <!-- Console Output -->
    <div class="console-output" id="consoleOutput"></div>

    <!-- MapLibre GL JS -->
    <script src="https://unpkg.com/maplibre-gl@4.1.1/dist/maplibre-gl.js"></script>
    
    <!-- LayersControl Component -->
    <script src="src/js/main.js"></script>

    <script>
        // Console logging for demo
        let consoleLines = [];
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;

        function addConsoleMessage(message, type = 'log') {
            const timestamp = new Date().toLocaleTimeString();
            const line = `[${timestamp}] ${message}`;
            consoleLines.push(line);
            if (consoleLines.length > 20) consoleLines.shift();
            
            const consoleOutput = document.getElementById('consoleOutput');
            consoleOutput.innerHTML = consoleLines.map(line => 
                `<div class="console-line">${line}</div>`
            ).join('');
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }

        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            addConsoleMessage(args.join(' '), 'log');
        };

        console.error = function(...args) {
            originalConsoleError.apply(console, args);
            addConsoleMessage('ERROR: ' + args.join(' '), 'error');
        };

        console.warn = function(...args) {
            originalConsoleWarn.apply(console, args);
            addConsoleMessage('WARN: ' + args.join(' '), 'warn');
        };

        function toggleConsole() {
            const consoleOutput = document.getElementById('consoleOutput');
            consoleOutput.classList.toggle('show');
        }

        // Sample GeoJSON data for demo
        const sampleRestaurants = {
            type: 'FeatureCollection',
            features: [
                {
                    type: 'Feature',
                    geometry: { type: 'Point', coordinates: [-74.0060, 40.7128] },
                    properties: { name: 'Joe\'s Pizza', type: 'restaurant' }
                },
                {
                    type: 'Feature', 
                    geometry: { type: 'Point', coordinates: [-74.0100, 40.7200] },
                    properties: { name: 'Burger Palace', type: 'restaurant' }
                },
                {
                    type: 'Feature',
                    geometry: { type: 'Point', coordinates: [-73.9900, 40.7300] },
                    properties: { name: 'Sushi Bar', type: 'restaurant' }
                }
            ]
        };

        const sampleMuseums = {
            type: 'FeatureCollection',
            features: [
                {
                    type: 'Feature',
                    geometry: { type: 'Point', coordinates: [-73.9857, 40.7580] },
                    properties: { name: 'Metropolitan Museum', type: 'museum' }
                },
                {
                    type: 'Feature',
                    geometry: { type: 'Point', coordinates: [-73.9776, 40.7614] },
                    properties: { name: 'Guggenheim Museum', type: 'museum' }
                },
                {
                    type: 'Feature',
                    geometry: { type: 'Point', coordinates: [-73.9735, 40.7505] },
                    properties: { name: 'Museum of Modern Art', type: 'museum' }
                }
            ]
        };

        // Configuration
        const baseStyles = [
            {
                id: 'osm-liberty',
                label: 'OSM Liberty',
                style: 'https://demotiles.maplibre.org/style.json',
                strategy: 'setStyle'
            },
            {
                id: 'satellite',
                label: 'Satellite Imagery',
                style: {
                    version: 8,
                    sources: {
                        'satellite': {
                            type: 'raster',
                            tiles: ['https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'],
                            tileSize: 256,
                            attribution: '© Esri'
                        }
                    },
                    layers: [
                        {
                            id: 'satellite-layer',
                            type: 'raster',
                            source: 'satellite'
                        }
                    ]
                },
                strategy: 'setStyle'
            }
        ];

        const overlays = [
            {
                id: 'restaurants',
                label: 'Restaurants',
                group: 'Points of Interest',
                source: {
                    id: 'restaurants-source',
                    type: 'geojson',
                    options: {
                        data: sampleRestaurants
                    }
                },
                layers: [
                    {
                        id: 'restaurants-layer',
                        type: 'circle',
                        source: 'restaurants-source',
                        paint: {
                            'circle-color': '#ff6b6b',
                            'circle-radius': 8,
                            'circle-stroke-color': '#ffffff',
                            'circle-stroke-width': 2
                        }
                    },
                    {
                        id: 'restaurants-labels',
                        type: 'symbol',
                        source: 'restaurants-source',
                        layout: {
                            'text-field': ['get', 'name'],
                            'text-font': ['Open Sans Regular'],
                            'text-offset': [0, 1.5],
                            'text-anchor': 'top',
                            'text-size': 12
                        },
                        paint: {
                            'text-color': '#333333',
                            'text-halo-color': '#ffffff',
                            'text-halo-width': 1
                        }
                    }
                ],
                defaultVisible: false,
                opacityControls: true,
                panOnAdd: true,
                panZoom: 12
            },
            {
                id: 'museums',
                label: 'Museums',
                group: 'Points of Interest',
                source: {
                    id: 'museums-source',
                    type: 'geojson',
                    options: {
                        data: sampleMuseums
                    }
                },
                layers: [
                    {
                        id: 'museums-layer',
                        type: 'circle',
                        source: 'museums-source',
                        paint: {
                            'circle-color': '#4ecdc4',
                            'circle-radius': 8,
                            'circle-stroke-color': '#ffffff',
                            'circle-stroke-width': 2
                        }
                    },
                    {
                        id: 'museums-labels',
                        type: 'symbol',
                        source: 'museums-source',
                        layout: {
                            'text-field': ['get', 'name'],
                            'text-font': ['Open Sans Regular'],
                            'text-offset': [0, 1.5],
                            'text-anchor': 'top',
                            'text-size': 12
                        },
                        paint: {
                            'text-color': '#333333',
                            'text-halo-color': '#ffffff',
                            'text-halo-width': 1
                        }
                    }
                ],
                defaultVisible: false,
                opacityControls: true,
                panOnAdd: true,
                panZoom: 12
            },
            {
                id: 'weather-radar',
                label: 'Weather Radar (Dynamic)',
                renderOnClick: async () => {
                    console.log('Loading weather radar data...');
                    
                    // Simulate API call delay
                    return new Promise(resolve => {
                        setTimeout(() => {
                            console.log('Weather radar data loaded successfully');
                            resolve({
                                source: {
                                    id: 'radar-source',
                                    type: 'image',
                                    options: {
                                        url: 'https://docs.mapbox.com/mapbox-gl-js/assets/radar.gif',
                                        coordinates: [
                                            [-80.425, 46.437],
                                            [-71.516, 46.437], 
                                            [-71.516, 37.936],
                                            [-80.425, 37.936]
                                        ]
                                    }
                                },
                                layers: [
                                    {
                                        id: 'radar-layer',
                                        type: 'raster',
                                        source: 'radar-source',
                                        paint: {
                                            'raster-opacity': 0.8
                                        }
                                    }
                                ]
                            });
                        }, 1500);
                    });
                },
                defaultVisible: false,
                opacityControls: true,
                panOnAdd: true,
                panZoom: 6
            },
            {
                id: 'traffic-simulation',
                label: 'Traffic Simulation',
                source: {
                    id: 'traffic-source',
                    type: 'geojson',
                    options: {
                        data: {
                            type: 'FeatureCollection',
                            features: [
                                {
                                    type: 'Feature',
                                    geometry: {
                                        type: 'LineString',
                                        coordinates: [
                                            [-74.0059, 40.7128],
                                            [-74.0000, 40.7200],
                                            [-73.9950, 40.7250]
                                        ]
                                    },
                                    properties: { traffic: 'heavy' }
                                },
                                {
                                    type: 'Feature',
                                    geometry: {
                                        type: 'LineString',
                                        coordinates: [
                                            [-73.9900, 40.7300],
                                            [-73.9850, 40.7350],
                                            [-73.9800, 40.7400]
                                        ]
                                    },
                                    properties: { traffic: 'light' }
                                }
                            ]
                        }
                    }
                },
                layers: [
                    {
                        id: 'traffic-heavy',
                        type: 'line',
                        source: 'traffic-source',
                        filter: ['==', ['get', 'traffic'], 'heavy'],
                        paint: {
                            'line-color': '#ff4757',
                            'line-width': 6,
                            'line-opacity': 0.8
                        }
                    },
                    {
                        id: 'traffic-light',
                        type: 'line',
                        source: 'traffic-source',
                        filter: ['==', ['get', 'traffic'], 'light'],
                        paint: {
                            'line-color': '#2ed573',
                            'line-width': 4,
                            'line-opacity': 0.8
                        }
                    }
                ],
                defaultVisible: false,
                opacityControls: true
            }
        ];

        // Get initial style to prevent flicker
        const initialStyle = LayersControl.getInitialStyle({
            baseStyles: baseStyles,
            defaultBaseId: 'osm-liberty',
            persist: {
                localStorageKey: 'layerscontrol-demo'
            }
        });

        // Initialize MapLibre map
        const map = new maplibregl.Map({
            container: 'map',
            style: initialStyle || baseStyles[0].style,
            center: [-74.0060, 40.7128], // New York City
            zoom: 11
        });

        // Create LayersControl instance
        const layersControl = new LayersControl({
            baseStyles: baseStyles,
            overlays: overlays,
            defaultBaseId: 'osm-liberty',
            persist: {
                localStorageKey: 'layerscontrol-demo'
            },
            showOpacity: true,
            autoClose: false, // Keep panel open for demo
            position: 'top-right',
            i18n: (key) => {
                const translations = {
                    'Base Maps': 'Base Maps',
                    'Overlays': 'Data Layers',
                    'layers': 'Layer Control'
                };
                return translations[key] || key;
            },
            onChange: (state) => {
                console.log('LayersControl state changed:', state);
            },
            icon: `<svg width="28px" height="28px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M4.97883 9.68508C2.99294 8.89073 2 8.49355 2 8C2 7.50645 2.99294 7.10927 4.97883 6.31492L7.7873 5.19153C9.77318 4.39718 10.7661 4 12 4C13.2339 4 14.2268 4.39718 16.2127 5.19153L19.0212 6.31492C21.0071 7.10927 22 7.50645 22 8C22 8.49355 21.0071 8.89073 19.0212 9.68508L16.2127 10.8085C14.2268 11.6028 13.2339 12 12 12C10.7661 12 9.77318 11.6028 7.7873 10.8085L4.97883 9.68508Z" fill="#1C274C"/>
                <path fill-rule="evenodd" clip-rule="evenodd" d="M2 8C2 8.49355 2.99294 8.89073 4.97883 9.68508L7.7873 10.8085C9.77318 11.6028 10.7661 12 12 12C13.2339 12 14.2268 11.6028 16.2127 10.8085L19.0212 9.68508C21.0071 8.89073 22 8.49355 22 8C22 7.50645 21.0071 7.10927 19.0212 6.31492L16.2127 5.19153C14.2268 4.39718 13.2339 4 12 4C10.7661 4 9.77318 4.39718 7.7873 5.19153L4.97883 6.31492C2.99294 7.10927 2 7.50645 2 8Z" fill="#1C274C"/>
                <path opacity="0.7" d="M5.76613 10L4.97883 10.3149C2.99294 11.1093 2 11.5065 2 12C2 12.4935 2.99294 12.8907 4.97883 13.6851L7.7873 14.8085C9.77318 15.6028 10.7661 16 12 16C13.2339 16 14.2268 15.6028 16.2127 14.8085L19.0212 13.6851C21.0071 12.8907 22 12.4935 22 12C22 11.5065 21.0071 11.1093 19.0212 10.3149L18.2339 10L16.2127 10.8085C14.2268 11.6028 13.2339 12 12 12C10.7661 12 9.77318 11.6028 7.7873 10.8085L5.76613 10Z" fill="#1C274C"/>
                <path opacity="0.4" d="M5.76613 14L4.97883 14.3149C2.99294 15.1093 2 15.5065 2 16C2 16.4935 2.99294 16.8907 4.97883 17.6851L7.7873 18.8085C9.77318 19.6028 10.7661 20 12 20C13.2339 20 14.2268 19.6028 16.2127 18.8085L19.0212 17.6851C21.0071 16.8907 22 16.4935 22 16C22 15.5065 21.0071 15.1093 19.0212 14.3149L18.2339 14L16.2127 14.8085C14.2268 15.6028 13.2339 16 12 16C10.7661 16 9.77318 15.6028 7.7873 14.8085L5.76613 14Z" fill="#1C274C"/>
            </svg>`
        });

        // Add control to map when loaded
        map.on('load', () => {
            console.log('Map loaded, adding LayersControl...');
            layersControl.addTo(map);

            // Demo: Programmatic interactions
            setTimeout(() => {
                console.log('Demo: Programmatically enabling restaurants...');
                layersControl.toggleOverlay('restaurants', true);
            }, 3000);

            setTimeout(() => {
                console.log('Demo: Setting restaurants opacity to 70%...');
                layersControl.setOverlayOpacity('restaurants', 0.7);
            }, 5000);

            setTimeout(() => {
                console.log('Demo: Switching to satellite base map...');
                layersControl.setBase('satellite');
            }, 7000);

            setTimeout(() => {
                console.log('Demo: Enabling Points of Interest group...');
                layersControl.toggleOverlayGroup('Points of Interest', true);
            }, 9000);
        });

        // Event listeners for demo
        layersControl.on('basechange', (data) => {
            console.log(`Base map changed from '${data.previousBaseId}' to '${data.baseId}'`);
        });

        layersControl.on('overlaychange', (data) => {
            console.log(`Overlay '${data.id}' visibility: ${data.visible}, opacity: ${data.opacity}`);
        });

        layersControl.on('overlaygroupchange', (data) => {
            console.log(`Group '${data.groupId}' visibility: ${data.visible}, affects overlays: [${data.overlays.join(', ')}]`);
        });

        layersControl.on('loading', (data) => {
            console.log(`Loading overlay: ${data.id}`);
        });

        layersControl.on('error', (data) => {
            console.error(`Error loading overlay '${data.id}': ${data.error}`);
        });

        // Add navigation controls
        map.addControl(new maplibregl.NavigationControl(), 'top-left');
        map.addControl(new maplibregl.ScaleControl(), 'bottom-left');

        console.log('LayersControl Demo initialized!');
        console.log('Try toggling layers, adjusting opacity, and refreshing the page to see state persistence.');
    </script>
</body>
</html>