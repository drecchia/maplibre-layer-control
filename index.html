<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LayersControl - Refactored Demo</title>
    
    <!-- MapLibre GL CSS -->
    <link href="https://unpkg.com/maplibre-gl@4.1.1/dist/maplibre-gl.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/deck.gl@9.1.14/dist/stylesheet.min.css">
    <link href="./src/css/main.css" rel="stylesheet">
    
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }        

        /* Console Output */
        .console-output {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: #00ff00;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-width: 400px;
            max-height: 150px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .console-output.show {
            display: block;
        }

        .console-line {
            margin-bottom: 2px;
        }

        .console-toggle {
            position: absolute;
            bottom: 10px;
            right: 60px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            z-index: 1000;
        }

        .console-toggle:hover {
            background: rgba(0, 0, 0, 0.9);
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <!-- Console Toggle -->
    <button class="console-toggle" onclick="toggleConsole()">Toggle Console</button>
    
    <!-- Console Output -->
    <div class="console-output" id="consoleOutput"></div>

    <!-- MapLibre GL JS -->
    <script src="https://unpkg.com/maplibre-gl@4.1.1/dist/maplibre-gl.js"></script>
    
    <!-- Deck.gl CDN -->
    <script src="https://cdn.jsdelivr.net/npm/deck.gl@9.1.14/dist.min.js" integrity="sha256-BZs9dCF93d5VJUgojI/H2++LbrcE6UXIPnZ2mC4PCAM=" crossorigin="anonymous"></script>
    
    <!-- LayersControl Component -->
    <script src="src/js/main.js"></script>

    <script>
        // Console logging for demo
        let consoleLines = [];
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;

        function addConsoleMessage(message, type = 'log') {
            const timestamp = new Date().toLocaleTimeString();
            const line = `[${timestamp}] ${message}`;
            consoleLines.push(line);
            if (consoleLines.length > 20) consoleLines.shift();
            
            const consoleOutput = document.getElementById('consoleOutput');
            consoleOutput.innerHTML = consoleLines.map(line => 
                `<div class="console-line">${line}</div>`
            ).join('');
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }

        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            addConsoleMessage(args.join(' '), 'log');
        };

        console.error = function(...args) {
            originalConsoleError.apply(console, args);
            addConsoleMessage('ERROR: ' + args.join(' '), 'error');
        };

        console.warn = function(...args) {
            originalConsoleWarn.apply(console, args);
            addConsoleMessage('WARN: ' + args.join(' '), 'warn');
        };

        function toggleConsole() {
            const consoleOutput = document.getElementById('consoleOutput');
            consoleOutput.classList.toggle('show');
        }

        // Sample GeoJSON data for demo
        const sampleRestaurants = {
            type: 'FeatureCollection',
            features: [
                {
                    type: 'Feature',
                    geometry: { type: 'Point', coordinates: [-74.0060, 40.7128] },
                    properties: { name: 'Joe\'s Pizza', type: 'restaurant' }
                },
                {
                    type: 'Feature', 
                    geometry: { type: 'Point', coordinates: [-74.0100, 40.7200] },
                    properties: { name: 'Burger Palace', type: 'restaurant' }
                },
                {
                    type: 'Feature',
                    geometry: { type: 'Point', coordinates: [-73.9900, 40.7300] },
                    properties: { name: 'Sushi Bar', type: 'restaurant' }
                }
            ]
        };

        const sampleMuseums = {
            type: 'FeatureCollection',
            features: [
                {
                    type: 'Feature',
                    geometry: { type: 'Point', coordinates: [-73.9857, 40.7580] },
                    properties: { name: 'Metropolitan Museum', type: 'museum' }
                },
                {
                    type: 'Feature',
                    geometry: { type: 'Point', coordinates: [-73.9776, 40.7614] },
                    properties: { name: 'Guggenheim Museum', type: 'museum' }
                },
                {
                    type: 'Feature',
                    geometry: { type: 'Point', coordinates: [-73.9735, 40.7505] },
                    properties: { name: 'Museum of Modern Art', type: 'museum' }
                }
            ]
        };

        // Configuration
        const baseStyles = [
            {
                id: 'osm-liberty',
                label: 'OSM Liberty',
                style: 'https://demotiles.maplibre.org/style.json',
                strategy: 'setStyle'
            },
            {
                id: 'satellite',
                label: 'Satellite Imagery',
                style: {
                    version: 8,
                    sources: {
                        'satellite': {
                            type: 'raster',
                            tiles: ['https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'],
                            tileSize: 256,
                            attribution: 'Â© Esri'
                        }
                    },
                    layers: [
                        {
                            id: 'satellite-layer',
                            type: 'raster',
                            source: 'satellite'
                        }
                    ]
                },
                strategy: 'setStyle'
            },{
                id: 'carto-positron',
                label: 'Carto Positron',
                strategy: 'setStyle',
                style: 'https://basemaps.cartocdn.com/gl/positron-gl-style/style.json'
            },{
                id: 'waze-streets',
                label: 'Waze Streets',
                strategy: 'setStyle',
                style: {
                    version: 8,
                    sources: {
                        'raster-tiles-waze': {
                            type: 'raster',
                            tiles: [
                                'https://worldtiles1.waze.com/tiles/{z}/{x}/{y}.png',
                                'https://worldtiles2.waze.com/tiles/{z}/{x}/{y}.png',
                                'https://worldtiles3.waze.com/tiles/{z}/{x}/{y}.png',
                                'https://worldtiles4.waze.com/tiles/{z}/{x}/{y}.png',
                            ],
                            tileSize: 256
                        }
                    },
                    layers: [{
                        id: 'simple-tiles-waze',
                        type: 'raster',
                        source: 'raster-tiles-waze',
                    }]
                }
            }
        ];

        const overlays = [
            {
                id: 'restaurants-deck',
                label: 'Restaurants',
                group: 'Points of Interest',
                deckLayers: [
                    {
                        id: 'restaurants-scatterplot',
                        type: 'ScatterplotLayer',
                        props: {
                            data: sampleRestaurants.features.map(f => ({
                                position: f.geometry.coordinates,
                                name: f.properties.name,
                                type: f.properties.type
                            })),
                            getPosition: d => d.position,
                            getRadius: 50,
                            getFillColor: [255, 107, 107],
                            getLineColor: [255, 255, 255],
                            lineWidthMinPixels: 2,
                            pickable: true,
                            onHover: (info) => {
                                if (info.object) {
                                    console.log('Hovered restaurant:', info.object.name);
                                }
                            }
                        }
                    }
                ],
                defaultVisible: false,
                opacityControls: true,
                panOnAdd: true,
                panZoom: 12
            },
            {
                id: 'museums-deck',
                label: 'Museums',
                group: 'Points of Interest',
                deckLayers: [
                    {
                        id: 'museums-scatterplot',
                        type: 'ScatterplotLayer',
                        props: {
                            data: sampleMuseums.features.map(f => ({
                                position: f.geometry.coordinates,
                                name: f.properties.name,
                                type: f.properties.type
                            })),
                            getPosition: d => d.position,
                            getRadius: 60,
                            getFillColor: [78, 205, 196],
                            getLineColor: [255, 255, 255],
                            lineWidthMinPixels: 2,
                            pickable: true,
                            onHover: (info) => {
                                if (info.object) {
                                    console.log('Hovered museum:', info.object.name);
                                }
                            }
                        }
                    }
                ],
                defaultVisible: false,
                opacityControls: true,
                panOnAdd: true,
                panZoom: 12
            },
            {
                id: 'arc-layer-demo',
                label: 'Flight Paths (Arc Layer)',
                group: 'Deck.gl Demos',
                deckLayers: [
                    {
                        id: 'arc-layer',
                        type: 'ArcLayer',
                        props: {
                            data: [
                                { source: [-74.0060, 40.7128], target: [-73.9857, 40.7580] }, // NYC to Met Museum
                                { source: [-74.0100, 40.7200], target: [-73.9776, 40.7614] }, // Point to Guggenheim
                                { source: [-73.9900, 40.7300], target: [-73.9735, 40.7505] } // Point to MoMA
                            ],
                            getSourcePosition: d => d.source,
                            getTargetPosition: d => d.target,
                            getSourceColor: [0, 128, 200],
                            getTargetColor: [200, 0, 80],
                            getWidth: 3,
                            pickable: true
                        }
                    }
                ],
                defaultVisible: false,
                opacityControls: true
            },
            {
                id: 'heatmap-deck',
                label: 'Heatmap',
                group: 'Deck.gl Demos',
                deckLayers: [
                    {
                        id: 'heatmap-layer',
                        type: 'HeatmapLayer',
                        props: {
                            data: [
                                ...sampleRestaurants.features.map(f => ({
                                    position: f.geometry.coordinates,
                                    weight: Math.random() * 100
                                })),
                                ...sampleMuseums.features.map(f => ({
                                    position: f.geometry.coordinates,
                                    weight: Math.random() * 100
                                }))
                            ],
                            getPosition: d => d.position,
                            getWeight: d => d.weight,
                            radiusPixels: 100,
                            intensity: 1,
                            threshold: 0.03
                        }
                    }
                ],
                defaultVisible: false,
                opacityControls: true
            },
            {
                id: 'traffic-paths',
                label: 'Traffic Paths',
                group: 'Deck.gl Path',
                deckLayers: [
                    {
                        id: 'path-layer',
                        type: 'PathLayer',
                        props: {
                            data: [
                                {
                                    path: [
                                        [-74.0059, 40.7128],
                                        [-74.0000, 40.7200],
                                        [-73.9950, 40.7250]
                                    ],
                                    color: [255, 71, 87],
                                    width: 6
                                },
                                {
                                    path: [
                                        [-73.9900, 40.7300],
                                        [-73.9850, 40.7350],
                                        [-73.9800, 40.7400]
                                    ],
                                    color: [46, 213, 115],
                                    width: 4
                                }
                            ],
                            getPath: d => d.path,
                            getColor: d => d.color,
                            getWidth: d => d.width,
                            pickable: true
                        }
                    }
                ],
                defaultVisible: false,
                opacityControls: true
            },{
                id: 'weather-radar',
                label: 'Weather Radar (Dynamic)',
                group: 'Weather',
                defaultOpacity: 0.8, // Set initial opacity to match the layer default
                renderOnClick: async (context) => {
                    console.log('Loading weather radar data...');
                    
                    // Simulate API call delay
                    return new Promise(resolve => {
                        setTimeout(() => {
                            console.log('Weather radar data loaded successfully');
                            
                            // Example: Adjust data based on current viewport
                            const viewport = context.getCurrentViewport();
                            const dynamicOpacity = viewport.zoom > 8 ? 0.8 : 0.6;
                            
                            resolve({
                                deckLayers: [
                                    {
                                        id: 'radar-bitmap-layer',
                                        type: 'BitmapLayer',
                                        props: {
                                            image: 'https://docs.mapbox.com/mapbox-gl-js/assets/radar.gif',
                                            bounds: [
                                                -80.425, 37.936,  // [west, south]
                                                -71.516, 46.437   // [east, north]
                                            ],
                                            opacity: dynamicOpacity, // Dynamic opacity based on zoom level
                                            pickable: false
                                        }
                                    }
                                ]
                            });
                        }, 1500);
                    });
                },
                defaultVisible: false,
                opacityControls: true,
                panOnAdd: true,
                panZoom: 10
            }
        ];

        // Get initial style to prevent flicker
        const initialStyle = LayersControl.getInitialStyle({
            baseStyles: baseStyles,
            defaultBaseId: 'osm-liberty',
            persist: {
                localStorageKey: 'layerscontrol-demo'
            }
        });

        // Get initial viewport state
        const initialViewport = LayersControl.getInitialViewport({
            persist: {
                localStorageKey: 'layerscontrol-demo'
            }
        });

        // Initialize MapLibre map with persisted viewport or defaults
        const mapOptions = {
            container: 'map',
            style: initialStyle || baseStyles[0].style,
            center: (initialViewport && initialViewport.center) ? initialViewport.center : [-74.0060, 40.7128],
            zoom: (initialViewport && typeof initialViewport.zoom === 'number') ? initialViewport.zoom : 11,
            bearing: (initialViewport && typeof initialViewport.bearing === 'number') ? initialViewport.bearing : 0,
            pitch: (initialViewport && typeof initialViewport.pitch === 'number') ? initialViewport.pitch : 0
        };

        const map = new maplibregl.Map(mapOptions);

        /*
         * renderOnClick Context Documentation
         * 
         * When using renderOnClick for dynamic overlays, a context object is passed
         * with the following properties and methods:
         * 
         * - context.map: MapLibre GL JS map instance for direct map manipulation
         * - context.overlayManager: OverlayManager instance for layer operations
         * - context.stateStore: StateStore instance for accessing/modifying layer states
         * - context.overlayId: ID of the current overlay being rendered
         * - context.overlay: Full overlay configuration object
         * - context.isUserInteraction: Boolean indicating if triggered by user interaction
         * - context.deckOverlay: Deck.gl overlay instance for advanced operations
         * 
         * Helper Methods:
         * - context.getCurrentViewport(): Returns current map viewport {center, zoom, bearing, pitch}
         * - context.getOverlayState(id): Returns state of specific overlay {visible, opacity}
         * - context.getAllOverlayStates(): Returns all overlay states as object
         * 
         * Example usage:
         * renderOnClick: async (context) => {
         *     const viewport = context.getCurrentViewport();
         *     const bounds = context.map.getBounds();
         *     const visibleOverlays = Object.entries(context.getAllOverlayStates())
         *         .filter(([id, state]) => state.visible);
         *     
         *     // Use data to customize layer creation...
         *     return { deckLayers: [...] };
         * }
         */

        // Create LayersControl instance
        const layersControl = new LayersControl({
            baseStyles: baseStyles,
            overlays: overlays,
            defaultBaseId: 'osm-liberty',
            persist: {
                localStorageKey: 'layerscontrol-demo'
            },
            showOpacity: true,
            autoClose: false, // Keep panel open for demo
            position: 'top-right',
            i18n: (key) => {
                const translations = {
                    'Base Maps': 'Camada Base',
                    'Overlays': 'Camadas de Dados',
                    'layers': 'Controlo de Camadas'
                };
                return translations[key] || key;
            },
            onChange: (state) => {
                console.log('LayersControl state changed:', state);
            },
            icon: `<svg width="28px" height="28px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M4.97883 9.68508C2.99294 8.89073 2 8.49355 2 8C2 7.50645 2.99294 7.10927 4.97883 6.31492L7.7873 5.19153C9.77318 4.39718 10.7661 4 12 4C13.2339 4 14.2268 4.39718 16.2127 5.19153L19.0212 6.31492C21.0071 7.10927 22 7.50645 22 8C22 8.49355 21.0071 8.89073 19.0212 9.68508L16.2127 10.8085C14.2268 11.6028 13.2339 12 12 12C10.7661 12 9.77318 11.6028 7.7873 10.8085L4.97883 9.68508Z" fill="#1C274C"/>
                <path fill-rule="evenodd" clip-rule="evenodd" d="M2 8C2 8.49355 2.99294 8.89073 4.97883 9.68508L7.7873 10.8085C9.77318 11.6028 10.7661 12 12 12C13.2339 12 14.2268 11.6028 16.2127 10.8085L19.0212 9.68508C21.0071 8.89073 22 8.49355 22 8C22 7.50645 21.0071 7.10927 19.0212 6.31492L16.2127 5.19153C14.2268 4.39718 13.2339 4 12 4C10.7661 4 9.77318 4.39718 7.7873 5.19153L4.97883 6.31492C2.99294 7.10927 2 7.50645 2 8Z" fill="#1C274C"/>
                <path opacity="0.7" d="M5.76613 10L4.97883 10.3149C2.99294 11.1093 2 11.5065 2 12C2 12.4935 2.99294 12.8907 4.97883 13.6851L7.7873 14.8085C9.77318 15.6028 10.7661 16 12 16C13.2339 16 14.2268 15.6028 16.2127 14.8085L19.0212 13.6851C21.0071 12.8907 22 12.4935 22 12C22 11.5065 21.0071 11.1093 19.0212 10.3149L18.2339 10L16.2127 10.8085C14.2268 11.6028 13.2339 12 12 12C10.7661 12 9.77318 11.6028 7.7873 10.8085L5.76613 10Z" fill="#1C274C"/>
                <path opacity="0.4" d="M5.76613 14L4.97883 14.3149C2.99294 15.1093 2 15.5065 2 16C2 16.4935 2.99294 16.8907 4.97883 17.6851L7.7873 18.8085C9.77318 19.6028 10.7661 20 12 20C13.2339 20 14.2268 19.6028 16.2127 18.8085L19.0212 17.6851C21.0071 16.8907 22 16.4935 22 16C22 15.5065 21.0071 15.1093 19.0212 14.3149L18.2339 14L16.2127 14.8085C14.2268 15.6028 13.2339 16 12 16C10.7661 16 9.77318 15.6028 7.7873 14.8085L5.76613 14Z" fill="#1C274C"/>
            </svg>`
        });

        // Add control to map when loaded
        map.on('load', () => {
            console.log('Map loaded, adding LayersControl...');
            layersControl.addTo(map);

            // Demo: Programmatic interactions
            // setTimeout(() => {
            //     console.log('Demo: Programmatically enabling restaurants...');
            //     layersControl.toggleOverlay('restaurants', true);
            // }, 3000);

            // setTimeout(() => {
            //     console.log('Demo: Setting restaurants opacity to 70%...');
            //     layersControl.setOverlayOpacity('restaurants', 0.7);
            // }, 5000);

            // setTimeout(() => {
            //     console.log('Demo: Switching to satellite base map...');
            //     layersControl.setBase('satellite');
            // }, 7000);

            // setTimeout(() => {
            //     console.log('Demo: Enabling Points of Interest group...');
            //     layersControl.toggleOverlayGroup('Points of Interest', true);
            // }, 9000);
        });

        // Event listeners for demo
        layersControl.on('basechange', (data) => {
            console.log(`Base map changed from '${data.previousBaseId}' to '${data.baseId}'`);
        });

        layersControl.on('overlaychange', (data) => {
            console.log(`Overlay '${data.id}' visibility: ${data.visible}, opacity: ${data.opacity}`);
        });

        layersControl.on('overlaygroupchange', (data) => {
            console.log(`Group '${data.groupId}' visibility: ${data.visible}, affects overlays: [${data.overlays.join(', ')}]`);
        });

        layersControl.on('loading', (data) => {
            console.log(`Loading overlay: ${data.id}`);
        });

        layersControl.on('error', (data) => {
            console.error(`Error loading overlay '${data.id}': ${data.error}`);
        });

        // Add navigation controls
        map.addControl(new maplibregl.NavigationControl(), 'top-left');
        map.addControl(new maplibregl.ScaleControl(), 'bottom-left');

        console.log('LayersControl Demo initialized!');
        console.log('Try toggling layers, adjusting opacity, and refreshing the page to see state persistence.');
    </script>
</body>
</html>